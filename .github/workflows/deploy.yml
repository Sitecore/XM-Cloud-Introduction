name: Build and Release
on: 
  push:
  pull_request:
    branches: [ main ]
    paths-ignore:
    - 'README.md'

jobs:

  # build-cm:
  #   name: Build the .NET Solution
  #   runs-on: windows-latest
  #   steps:
  #   - uses: actions/checkout@v3
  #   - name: Setup MSBuild path
  #     uses: microsoft/setup-msbuild@v1.1
  #   - name: Setup NuGet
  #     uses: NuGet/setup-nuget@v1.0.6
  #   - name: Restore NuGet packages
  #     run: nuget restore src\XmCloudIntroduction.sln
  #   - name: Build
  #     run: msbuild src\XmCloudIntroduction.sln /p:Configuration=Release

  deploy-cm:
    name: Deploy the CM asset to XM Cloud
    # needs: build-cm
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-dotnet@v2
      with:
        dotnet-version: '3.1.x' 
    - run: dotnet tool restore
    - run: dotnet sitecore --help

    # Temp fix to use Beta instance of XM CLoud
    - name: "TEMP: Update configs to use beta instance of XM CLoud"
      shell: pwsh
      run: |
          $pluginJsonFiles = Get-ChildItem -path ".sitecore\package-cache\nuget\Sitecore.DevEx.Extensibility.XMCloud.*" -filter plugin.json -Recurse
          $pluginJsonContent = Get-Content xmcloud.plugin.beta.json
          foreach ($pluginJsonFile in $pluginJsonFiles) {
              $pluginJsonContent | Set-Content -Path $pluginJsonFile.FullName
          }

    - name: Authenticate CLI with XM Cloud
    - run: dotnet sitecore cloud login --client-credentials --client-id ${{ secrets.BETA_CLIENT_ID }} --client-secret ${{ secrets.BETA_CLIENT_SECRET }} --authority https://auth-beta.sitecorecloud.io/
    
    # Temp fix to remove duplicate sln file
    - name: "TEMP: Delete duplicate sln file as not currently supported"
      run: |
          cd src
          rm -f XmCloudIntroduction.sln

    #- run: dotnet sitecore cloud deployment create --environment-id ${{ secrets.STAGING_ENVIRONMENT_ID }} --upload
    - run: dotnet sitecore login --ref xmcloud --client-credentials --client-id ${{ secrets.BETA_CLIENT_ID }} --client-secret ${{ secrets.BETA_CLIENT_SECRET }} --authority https://auth-beta.sitecorecloud.io/
# dotnet sitecore

  # build-sugcon-eu:
  #   name: Build the SUGCON EU head
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       working-directory: ./src/Project/SugconEu/rendering
  #   steps:
  #   - uses: actions/checkout@v3
  #   - uses: actions/setup-node@v3
  #     with:
  #       node-version: 16.5
  #   - run: npm build
